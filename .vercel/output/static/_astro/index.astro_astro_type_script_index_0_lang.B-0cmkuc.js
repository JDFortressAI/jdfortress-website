const m=window.__calcC,r=window.__calcSL,k=window.__calcProposalTemplate,v=window.__calcMeta;function q(t,e){return t.replace(/\{\{(\w+)\}\}/g,(n,s)=>s in e?e[s]:`{{${s}}}`)}function u(t,e=0){return isFinite(t)?"£"+t.toLocaleString("en-GB",{minimumFractionDigits:e,maximumFractionDigits:e}):"—"}function M(t,e=1){return isFinite(t)?t.toLocaleString("en-GB",{minimumFractionDigits:e,maximumFractionDigits:e}):"—"}function z(t){return!isFinite(t)||t<=0?"—":`${t} month${t===1?"":"s"}`}function V(t,e,n){t=Math.max(r.lawyers.min,Math.min(r.lawyers.max,Math.round(t)));const s=Math.min(r.vaults.max,2*t);e=Math.max(r.vaults.min,Math.min(s,Math.round(e))),n=Math.max(r.years.min,Math.min(r.years.max,Math.round(n)));const a=e*m.HARDWARE_PER_VAULT,i=m.SETUP_FIRST+(e-1)*m.SETUP_ADDITIONAL,c=m.TRAINING,o=a+i+c,l=m.VAT*o,E=o+l,f=m.ELECTRICITY_PER_VAULT*e,S=Math.max(0,e-3),g=m.SUPPORT_FLAT_RATE+S*m.SUPPORT_PER_ADDITIONAL,h=f+g,p=h*12;let L=0;for(let A=1;A<=n;A++)L+=p/Math.pow(1+m.DISCOUNT_RATE,A);const F=E+L,b=m.HOURS_PER_MONTH*(1-1/m.PRODUCTIVITY_MULT),T=b*t,w=T/m.HOURS_PER_MONTH,B=w*m.HIRING_COST_PER_FTE,C=m.AVG_SALARY_YEAR*w,N=C*n+B,$=T*m.RECOUP_RATE,D=$*m.BILLING_RATE,U=D*12,Y=U*n,R=Y+N;let P;return R<=0?P=1/0:P=Math.ceil(F/R*12*n),{numLawyers:t,numVaults:e,timeHorizon:n,hardware:a,setup:i,training:c,subtotal:o,vat:l,totalInitial:E,electricityMo:f,supportMo:g,totalRunningMo:h,totalRunningYr:p,totalCostNPV:F,timeSavedPerLawyerMo:b,totalTimeSavedMo:T,equivalentFTE:w,avoidedHiring:B,salarySavingsYr:C,totalCostSavings:N,additionalBillableMo:$,additionalRevenueMo:D,additionalRevenueYr:U,additionalRevenueHorizon:Y,totalMoneySaved:R,roiMonths:P}}const I={};function O(t,e){const n=document.getElementById(t);if(!n)return;const s=e.replace(/[£,]/g,"").match(/[\d.]+/);if(!s){n.textContent=e;return}const a=parseFloat(s[0]),i=e.startsWith("£")?"£":"",c=e.includes("month")?a===1?" month":" months":"",o=parseFloat((n.textContent||"0").replace(/[£,]/g,"").match(/[\d.]+/)?.[0]||"0");I[t]!==null&&cancelAnimationFrame(I[t]);const l=performance.now(),E=400;function f(S){const g=Math.min((S-l)/E,1),h=1-Math.pow(1-g,3),p=o+(a-o)*h;i==="£"?n.textContent="£"+Math.round(p).toLocaleString("en-GB")+c:c.includes("month")?n.textContent=Math.round(p)+c:n.textContent=p.toFixed(1)+c,g<1?I[t]=requestAnimationFrame(f):(n.textContent=e,I[t]=null)}I[t]=requestAnimationFrame(f)}function j(t,e){const n=t.timeHorizon*12,s=isFinite(t.roiMonths)?t.roiMonths>n?`>${n} months`:z(t.roiMonths):"N/A";O("kpi-cost",u(t.totalCostNPV)),O("kpi-savings",u(t.totalMoneySaved));const a=document.getElementById("kpi-roi");a&&(a.textContent=s),d("b-initial",u(t.totalInitial)),d("b-vault-count",String(t.numVaults)),d("b-hardware",u(t.hardware)),d("b-setup",u(t.setup+t.training)),d("b-support-mo",u(t.supportMo,2)+"/mo"),d("b-elec-mo",u(t.electricityMo,2)+"/mo"),d("b-salary-yr",u(t.salarySavingsYr)+"/yr"),d("b-revenue-yr",u(t.additionalRevenueYr)+"/yr"),d("b-fte",M(t.equivalentFTE,1)+" FTE"),d("b-billable-mo",M(t.additionalBillableMo,1)+" hrs/mo"),d("b-time-saved",M(t.timeSavedPerLawyerMo,1)+" hrs"),J(t,e,s)}function d(t,e){const n=document.getElementById(t);n&&(n.textContent=e)}function J(t,e,n){const s=e.trim()||"Your Firm",a=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});d("proposal-firm",s),d("proposal-date",a);const i=document.getElementById("proposal-body");if(!i)return;const c=!isFinite(t.roiMonths)||t.roiMonths>t.timeHorizon*12?"with payback expected within the evaluation period":`with ROI in under <strong>${n}</strong>`,o={firmName:s,productivityMult:String(m.PRODUCTIVITY_MULT),numLawyers:String(t.numLawyers),lawyerPlural:t.numLawyers===1?"":"s",avgSalary:u(m.AVG_SALARY_YEAR),billingRate:u(m.BILLING_RATE),numVaults:String(t.numVaults),vaultPlural:t.numVaults===1?"":"s",totalInitial:u(t.totalInitial),totalRunningMo:u(t.totalRunningMo,2),salarySavingsYr:u(t.salarySavingsYr),equivalentFTE:M(t.equivalentFTE,1),ftePlural:t.equivalentFTE>=2?"s":"",revenueYr:u(t.additionalRevenueYr),timeHorizon:String(t.timeHorizon),yearPlural:t.timeHorizon===1?"":"s",totalSaved:u(t.totalMoneySaved),roiClause:c,contactEmail:v.contactEmail,contactPhone:v.contactPhone,founders:v.founders,foundersTitle:v.foundersTitle,foundersQuote:v.foundersQuote};i.innerHTML=q(k,o);const l=document.getElementById("print-content");l&&(l.innerHTML=`
      <h1 style="color:#0F2041; font-size:24px; margin:0 0 4px;">JD Fortress AI — Investment Proposal</h1>
      <p style="color:#56585E; font-size:13px; margin:0 0 32px;">Prepared for: ${s} | ${a}</p>
      ${i.innerHTML}
      <hr style="margin:32px 0; border:none; border-top:1px solid #e0e8f5;" />
      <p style="font-size:12px; color:#9ca3af;">All figures are estimates based on conservative assumptions. See jdfortress.com/calculator for full methodology.</p>
    `)}function x(t,e,n,s){const a=document.getElementById(t),i=document.getElementById(e);if(!a||!i)return;function c(){const o=(parseFloat(a.value)-n)/(s-n)*100;a.style.setProperty("--pct",o+"%")}a.addEventListener("input",()=>{let o=parseInt(a.value,10);o=Math.max(n,Math.min(s,o)),i.value=String(o),c(),y()}),i.addEventListener("input",()=>{let o=i.value.replace(/[^0-9]/g,"");if(o==="")return;let l=parseInt(o,10);isNaN(l)||(l=Math.max(n,Math.min(s,l)),a.value=String(l),i.value=String(l),c(),y())}),i.addEventListener("blur",()=>{let o=parseInt(i.value,10);(isNaN(o)||i.value.trim()==="")&&(o=parseInt(a.value,10)),o=Math.max(n,Math.min(s,o)),a.value=String(o),i.value=String(o),c(),y()}),i.addEventListener("keydown",o=>{if(o.key==="ArrowUp"){o.preventDefault();let l=Math.min(s,parseInt(i.value,10)+1);i.value=String(l),a.value=String(l),c(),y()}if(o.key==="ArrowDown"){o.preventDefault();let l=Math.max(n,parseInt(i.value,10)-1);i.value=String(l),a.value=String(l),c(),y()}}),c()}function G(){const t=document.getElementById("num-lawyers"),e=document.getElementById("slider-vaults"),n=document.getElementById("num-vaults"),s=document.getElementById("vault-max-label");if(!t||!e||!n)return;const a=parseInt(t.value,10)||r.lawyers.default,i=Math.min(r.vaults.max,2*a);e.max=String(i),n.max=String(i),s&&(s.textContent=String(i)),parseInt(n.value,10)>i&&(n.value=String(i),e.value=String(i));const o=r.vaults.min,l=(parseFloat(e.value)-o)/(i-o)*100;e.style.setProperty("--pct",l+"%")}let _=null;function y(){_&&clearTimeout(_),_=setTimeout(H,30)}function H(){G();const t=parseInt(document.getElementById("num-lawyers").value,10)||r.lawyers.default,e=parseInt(document.getElementById("num-vaults").value,10)||r.vaults.default,n=parseInt(document.getElementById("num-years").value,10)||r.years.default,s=document.getElementById("customer-name").value,a=V(t,e,n);j(a,s)}function Q(){const t=document.getElementById("print-area");t&&(t.style.display="block",window.print(),setTimeout(()=>{t.style.display="none"},1e3))}function W(){const t=document.getElementById("customer-name")?.value.trim()||"Your Firm",e=document.getElementById("num-lawyers")?.value||String(r.lawyers.default),n=document.getElementById("num-vaults")?.value||String(r.vaults.default),s=document.getElementById("num-years")?.value||String(r.years.default),a=V(parseInt(e),parseInt(n),parseInt(s)),i=isFinite(a.roiMonths)?`${a.roiMonths} months`:"N/A",c=encodeURIComponent(`JDFortVault ROI Proposal — ${t}`),o=encodeURIComponent(`JD Fortress AI — Cost Reduction Proposal for ${t}

INPUTS
Lawyers: ${a.numLawyers} | Vaults: ${a.numVaults} | Time horizon: ${a.timeHorizon} years

RESULTS
Total Cost (NPV): ${u(a.totalCostNPV)}
Total Savings & Revenue: ${u(a.totalMoneySaved)}
ROI Payback: ${i}

Salary savings: ${u(a.salarySavingsYr)}/yr | FTE avoided: ${M(a.equivalentFTE,1)}
Additional revenue: ${u(a.additionalRevenueYr)}/yr

Generated at jdfortress.com/calculator
Contact: ${v.contactEmail} | ${v.contactPhone}`);window.location.href=`mailto:${v.contactEmail}?subject=${c}&body=${o}`}document.addEventListener("DOMContentLoaded",()=>{x("slider-lawyers","num-lawyers",r.lawyers.min,r.lawyers.max),x("slider-vaults","num-vaults",r.vaults.min,r.vaults.max),x("slider-years","num-years",r.years.min,r.years.max),G(),document.getElementById("customer-name")?.addEventListener("input",y),H()});window.printProposal=Q;window.emailProposal=W;
