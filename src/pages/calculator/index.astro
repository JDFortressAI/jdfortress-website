---
import yaml from 'js-yaml';
import { marked } from 'marked';
import Layout from '../../layouts/Layout.astro';
import configRaw from './config.yaml?raw';
import proposalRaw from './_proposal.md?raw';

// â”€â”€ Load config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const config = yaml.load(configRaw) as any;

const meta      = config.meta;
const inputs    = config.inputs  as Array<any>;
const costs     = config.costs   as Array<any>;
const benefits  = config.benefits as Array<any>;
const products  = config.products as any;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getInput = (id: string) => inputs.find(i => i.id === id);
const getCostVal = (id: string): number => costs.find((c: any) => c.id === id)?.value ?? 0;
const getBenefitVal = (id: string): number => benefits.find((b: any) => b.id === id)?.value ?? 0;

function fmtConfigValue(value: number, format: string): string {
  if (format === 'gbp') {
    const decimals = value % 1 !== 0 ? 2 : 0;
    return 'Â£' + value.toLocaleString('en-GB', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  }
  if (format === 'percent')    return (value * 100) + '%';
  if (format === 'multiplier') return value + 'Ã—';
  return String(value);
}

function fmtProductVal(v: any): string {
  if (typeof v === 'number') return 'Â£' + v.toLocaleString('en-GB');
  return String(v);
}

// â”€â”€ Slider configs (passed to JS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const iLawyers = getInput('lawyers');
const iVaults  = getInput('vaults');
const iTime    = getInput('timeHorizon');

const sliderLimits = {
  lawyers: { min: iLawyers.min, max: iLawyers.max, default: iLawyers.default },
  vaults:  { min: iVaults.min,  max: iVaults.max,  default: iVaults.default  },
  years:   { min: iTime.min,    max: iTime.max,     default: iTime.default    },
};

// â”€â”€ JS constants object (keyed to match existing calculate() logic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C_obj = {
  HARDWARE_PER_VAULT:    getCostVal('hardwareCostPerVault'),
  SETUP_FIRST:           getCostVal('setupCostFirst'),
  SETUP_ADDITIONAL:      getCostVal('setupCostAdditional'),
  TRAINING:              getCostVal('trainingCost'),
  VAT:                   getCostVal('vatRate'),
  ELECTRICITY_PER_VAULT: getCostVal('electricityCostPerVaultMonth'),
  SUPPORT_FLAT_RATE:         getCostVal('supportFlatRateMonth'),
  SUPPORT_PER_ADDITIONAL:    getCostVal('supportCostPerAdditionalVault'),
  DISCOUNT_RATE:         getCostVal('discountRate'),
  PRODUCTIVITY_MULT:     getBenefitVal('productivityMultiplier'),
  HOURS_PER_MONTH:       getBenefitVal('hoursPerMonth'),
  RECOUP_RATE:           getBenefitVal('recoupRate'),
  AVG_SALARY_YEAR:       getBenefitVal('avgSalaryYear'),
  HIRING_COST_PER_FTE:   getBenefitVal('hiringCostPerFTE'),
  BILLING_RATE:          getBenefitVal('billingRate'),
};

// â”€â”€ Proposal template: markdown â†’ HTML at build time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Placeholders {{key}} are preserved; substitution happens client-side.
const proposalTemplate = await marked.parse(proposalRaw, { async: false }) as string;

// Initial vault max = min(yamlMax, 2 Ã— default lawyers) â€” matches what JS will compute on load
const vaultInitialMax = Math.min(iVaults.max, 2 * iLawyers.default);

// â”€â”€ Product table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const prodCols: Array<{ name: string; highlight?: boolean }> = products.columns;
const prodRows: Array<{ label: string; values: any[]; bold?: boolean }> = products.rows;
---

<Layout
  title="Cost Reduction Calculator â€” JD Fortress AI"
  description="See how much your law firm could save with JDFortVault. Input your firm details and instantly see the financial case for on-premises AI."
>

  <!-- HERO -->
  <section style="background:#0F2041; padding:72px 24px 56px; text-align:center;">
    <div style="max-width:760px; margin:0 auto;">
      <p style="color:#1E6FF5; font-size:0.85rem; font-weight:600; letter-spacing:0.12em; text-transform:uppercase; margin:0 0 16px;">{meta.title}</p>
      <h1 style="color:#fff; font-size:clamp(1.9rem, 5vw, 3rem); font-weight:700; line-height:1.1; letter-spacing:-0.03em; margin:0 0 20px;">
        {meta.heroHeading}
      </h1>
      <p style="color:rgba(255,255,255,0.7); font-size:1.05rem; line-height:1.7; margin:0 auto; max-width:560px;">
        {meta.heroSubtitle}
      </p>
      <p style="color:rgba(255,255,255,0.4); font-size:0.85rem; margin:16px 0 0; font-style:italic;">{meta.tagline}</p>
    </div>
  </section>

  <!-- MAIN CALCULATOR -->
  <div style="background:#F0F4FF; padding:48px 24px 80px;" id="calc-root">
    <div style="max-width:1100px; margin:0 auto;">

      <!-- INPUT PANEL -->
      <div style="background:#fff; border-radius:16px; padding:36px; box-shadow:0 2px 16px rgba(15,32,65,0.08); margin-bottom:32px;">
        <h2 style="color:#0D141A; font-size:1.1rem; font-weight:700; margin:0 0 28px;">Your Firm</h2>

        <!-- Customer name -->
        <div style="margin-bottom:32px;">
          <label style="display:block; color:#56585E; font-size:0.82rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:8px;" for="customer-name">Firm Name <span style="color:#9ca3af; font-weight:400; text-transform:none;">(optional)</span></label>
          <input
            id="customer-name"
            type="text"
            placeholder="Your Firm"
            maxlength="80"
            style="width:100%; max-width:320px; padding:10px 14px; border:1.5px solid #e0e8f5; border-radius:8px; font-size:0.95rem; color:#0D141A; outline:none; font-family:inherit; box-sizing:border-box; transition:border-color 0.2s;"
            onfocus="this.style.borderColor='#1E6FF5'"
            onblur="this.style.borderColor='#e0e8f5'"
          />
        </div>

        <!-- Three sliders -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:32px;">

          <!-- Lawyers slider -->
          <div class="slider-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;">
              <label style="color:#0D141A; font-size:0.95rem; font-weight:600;" for="slider-lawyers">{iLawyers.label}</label>
              <div style="display:flex; align-items:center; gap:4px;">
                <input id="num-lawyers" type="number" min={iLawyers.min} max={iLawyers.max} value={iLawyers.default} style="width:60px; padding:4px 8px; border:1.5px solid #e0e8f5; border-radius:6px; font-size:1rem; font-weight:700; color:#0F2041; text-align:center; font-family:inherit;" />
              </div>
            </div>
            <input id="slider-lawyers" type="range" min={iLawyers.min} max={iLawyers.max} value={iLawyers.default} step={iLawyers.step} class="calc-slider" />
            <div style="display:flex; justify-content:space-between; margin-top:4px;">
              <span style="color:#9ca3af; font-size:0.75rem;">{iLawyers.min}</span>
              <span style="color:#9ca3af; font-size:0.75rem;">{iLawyers.max}</span>
            </div>
          </div>

          <!-- Vaults slider -->
          <div class="slider-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;">
              <label style="color:#0D141A; font-size:0.95rem; font-weight:600;" for="slider-vaults">{iVaults.label}</label>
              <div style="display:flex; align-items:center; gap:4px;">
                <input id="num-vaults" type="number" min={iVaults.min} max={vaultInitialMax} value={iVaults.default} style="width:60px; padding:4px 8px; border:1.5px solid #e0e8f5; border-radius:6px; font-size:1rem; font-weight:700; color:#0F2041; text-align:center; font-family:inherit;" />
              </div>
            </div>
            <input id="slider-vaults" type="range" min={iVaults.min} max={vaultInitialMax} value={iVaults.default} step={iVaults.step} class="calc-slider" />
            <div style="display:flex; justify-content:space-between; margin-top:4px;">
              <span style="color:#9ca3af; font-size:0.75rem;">{iVaults.min}</span>
              <span id="vault-max-label" style="color:#9ca3af; font-size:0.75rem;">{vaultInitialMax}</span>
            </div>
          </div>

          <!-- Time Horizon slider -->
          <div class="slider-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;">
              <label style="color:#0D141A; font-size:0.95rem; font-weight:600;" for="slider-years">{iTime.label} ({iTime.unit})</label>
              <div style="display:flex; align-items:center; gap:4px;">
                <input id="num-years" type="number" min={iTime.min} max={iTime.max} value={iTime.default} style="width:60px; padding:4px 8px; border:1.5px solid #e0e8f5; border-radius:6px; font-size:1rem; font-weight:700; color:#0F2041; text-align:center; font-family:inherit;" />
              </div>
            </div>
            <input id="slider-years" type="range" min={iTime.min} max={iTime.max} value={iTime.default} step={iTime.step} class="calc-slider" />
            <div style="display:flex; justify-content:space-between; margin-top:4px;">
              <span style="color:#9ca3af; font-size:0.75rem;">{iTime.min} yr</span>
              <span style="color:#9ca3af; font-size:0.75rem;">{iTime.max} yrs</span>
            </div>
          </div>

        </div>
      </div>

      <!-- KPI CARDS -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:20px; margin-bottom:32px;">

        <div style="background:#0F2041; border-radius:16px; padding:32px; text-align:center; box-shadow:0 4px 24px rgba(15,32,65,0.2);">
          <p style="color:rgba(255,255,255,0.5); font-size:0.78rem; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; margin:0 0 12px;">Total Cost (NPV)</p>
          <p id="kpi-cost" style="color:#fff; font-size:2.2rem; font-weight:700; letter-spacing:-0.02em; margin:0 0 8px;">â€”</p>
          <p style="color:rgba(255,255,255,0.4); font-size:0.8rem; margin:0;">initial + running, discounted</p>
        </div>

        <div style="background:#1E6FF5; border-radius:16px; padding:32px; text-align:center; box-shadow:0 4px 24px rgba(30,111,245,0.3);">
          <p style="color:rgba(255,255,255,0.7); font-size:0.78rem; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; margin:0 0 12px;">Total Savings &amp; Revenue</p>
          <p id="kpi-savings" style="color:#fff; font-size:2.2rem; font-weight:700; letter-spacing:-0.02em; margin:0 0 8px;">â€”</p>
          <p style="color:rgba(255,255,255,0.6); font-size:0.8rem; margin:0;">over the time horizon</p>
        </div>

        <div style="background:#fff; border-radius:16px; padding:32px; text-align:center; border:2px solid #e0e8f5; box-shadow:0 4px 16px rgba(0,0,0,0.04);">
          <p style="color:#56585E; font-size:0.78rem; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; margin:0 0 12px;">ROI Payback Period</p>
          <p id="kpi-roi" style="color:#0F2041; font-size:2.2rem; font-weight:700; letter-spacing:-0.02em; margin:0 0 8px;">â€”</p>
          <p style="color:#9ca3af; font-size:0.8rem; margin:0;">to break even</p>
        </div>

      </div>

      <!-- BREAKDOWN PANEL -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-bottom:32px;">

        <!-- Cost Breakdown -->
        <div style="background:#fff; border-radius:16px; padding:32px; box-shadow:0 2px 12px rgba(15,32,65,0.06);">
          <h3 style="color:#0D141A; font-size:1rem; font-weight:700; margin:0 0 20px; display:flex; align-items:center; gap:8px;">
            <span style="width:10px; height:10px; background:#ef4444; border-radius:50%; display:inline-block;"></span>
            Cost Breakdown
          </h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Initial (incl. VAT)</span>
              <span id="b-initial" style="color:#0D141A; font-weight:700; font-size:0.95rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Hardware (<span id="b-vault-count">{iVaults.default}</span> vaults)</span>
              <span id="b-hardware" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Setup &amp; Training</span>
              <span id="b-setup" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Support/month</span>
              <span id="b-support-mo" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
              <span style="color:#56585E; font-size:0.9rem;">Electricity/month</span>
              <span id="b-elec-mo" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
          </div>
        </div>

        <!-- Savings Breakdown -->
        <div style="background:#fff; border-radius:16px; padding:32px; box-shadow:0 2px 12px rgba(15,32,65,0.06);">
          <h3 style="color:#0D141A; font-size:1rem; font-weight:700; margin:0 0 20px; display:flex; align-items:center; gap:8px;">
            <span style="width:10px; height:10px; background:#22c55e; border-radius:50%; display:inline-block;"></span>
            Savings &amp; Revenue Breakdown
          </h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Salary savings/year</span>
              <span id="b-salary-yr" style="color:#0D141A; font-weight:700; font-size:0.95rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Extra billable revenue/year</span>
              <span id="b-revenue-yr" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">FTE hires avoided</span>
              <span id="b-fte" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline; padding-bottom:10px; border-bottom:1px solid #f3f4f6;">
              <span style="color:#56585E; font-size:0.9rem;">Extra billable hrs/month</span>
              <span id="b-billable-mo" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
              <span style="color:#56585E; font-size:0.9rem;">Time saved/lawyer/month</span>
              <span id="b-time-saved" style="color:#0D141A; font-weight:600; font-size:0.9rem;">â€”</span>
            </div>
          </div>
        </div>

      </div>

      <!-- PROPOSAL CARD -->
      <div id="proposal-card" style="background:#fff; border-radius:16px; padding:48px; box-shadow:0 2px 12px rgba(15,32,65,0.06); margin-bottom:24px; border-top:4px solid #0F2041;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:16px; margin-bottom:32px;">
          <div>
            <img src="/logo-navy.png" alt="JD Fortress AI" style="height:40px; width:auto; margin-bottom:12px;" />
            <p style="color:#1E6FF5; font-size:0.85rem; font-weight:600; margin:0;">Subject: Immediate ROI Opportunity &#x2013; Secure On-Prem AI for Your Legal Team</p>
          </div>
          <div style="text-align:right;">
            <p style="color:#56585E; font-size:0.85rem; margin:0;" id="proposal-date"></p>
            <p style="color:#9ca3af; font-size:0.8rem; margin:4px 0 0;">Prepared for: <strong id="proposal-firm" style="color:#0D141A;">Your Firm</strong></p>
          </div>
        </div>

        <div id="proposal-body" style="color:#374151; font-size:0.97rem; line-height:1.85;">
          <!-- dynamically populated -->
        </div>

        <div style="border-top:1px solid #e0e8f5; padding-top:24px; margin-top:32px; display:flex; gap:12px; flex-wrap:wrap;">
          <button onclick="printProposal()" style="background:#0F2041; color:#fff; padding:10px 20px; border:none; border-radius:8px; font-size:0.9rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; font-family:inherit;" onmouseover="this.style.background='#1a3357'" onmouseout="this.style.background='#0F2041'">
            ðŸ“„ Download / Print PDF
          </button>
          <button id="email-btn" onclick="emailProposal()" style="background:#F0F4FF; color:#1E6FF5; padding:10px 20px; border:1.5px solid #1E6FF5; border-radius:8px; font-size:0.9rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; font-family:inherit;" onmouseover="this.style.background='#dde8ff'" onmouseout="this.style.background='#F0F4FF'">
            ðŸ“§ Email This Proposal
          </button>
        </div>
      </div>

      <!-- PRODUCT COMPARISON TABLE (from config.yaml) -->
      <div style="background:#fff; border-radius:16px; padding:36px; box-shadow:0 2px 12px rgba(15,32,65,0.06); margin-bottom:24px; overflow-x:auto;">
        <h3 style="color:#0D141A; font-size:1rem; font-weight:700; margin:0 0 20px;">JDF Product Range â€” Comparison</h3>
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:480px;">
          <thead>
            <tr style="border-bottom:2px solid #e0e8f5;">
              <th style="text-align:left; padding:10px 16px; color:#56585E; font-weight:600;"></th>
              {prodCols.map(col => (
                <th style={`text-align:center; padding:10px 16px; ${col.highlight ? 'background:#0F2041; color:#fff; font-weight:700; border-radius:6px 6px 0 0;' : 'color:#56585E; font-weight:600;'}`}>
                  {col.name}{col.highlight ? ' âœ“' : ''}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {prodRows.map((row, rowIdx) => (
              <tr style={rowIdx < prodRows.length - 1 ? 'border-bottom:1px solid #f3f4f6;' : ''}>
                <td style={`padding:12px 16px; ${row.bold ? 'color:#0D141A; font-weight:700;' : 'color:#56585E;'}`}>{row.label}</td>
                {prodCols.map((col, colIdx) => (
                  <td style={`padding:12px 16px; text-align:center; ${col.highlight ? (rowIdx === prodRows.length - 1 ? 'background:#0F2041; color:#fff; font-weight:700; border-radius:0 0 6px 6px;' : 'background:#f0f4ff; color:#0D141A; font-weight:600;') : `color:#0D141A;${row.bold ? ' font-weight:700;' : ''}`}`}>
                    {fmtProductVal(row.values[colIdx])}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
        <p style="color:#9ca3af; font-size:0.8rem; margin:12px 0 0; font-style:italic;">{products.footnote}</p>
      </div>

      <!-- ASSUMPTIONS ACCORDION (from config.yaml) -->
      <details style="background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(15,32,65,0.06); overflow:hidden; margin-bottom:24px;">
        <summary style="padding:24px 32px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; list-style:none; user-select:none;">
          <span style="color:#0D141A; font-size:0.95rem; font-weight:700;">â–¸ Assumptions &amp; Methodology</span>
          <span style="color:#9ca3af; font-size:0.82rem;">Click to expand</span>
        </summary>
        <div style="padding:0 32px 32px; overflow-x:auto;">
          <p style="color:#56585E; font-size:0.9rem; margin:0 0 20px; line-height:1.6;">All monetary values in GBP (Â£). These constants underpin every calculation. They are based on 2025 UK market rates and our deployment experience.</p>
          <table style="width:100%; border-collapse:collapse; font-size:0.85rem; min-width:480px;">
            <thead>
              <tr style="background:#F0F4FF; border-bottom:2px solid #e0e8f5;">
                <th style="text-align:left; padding:10px 14px; color:#0D141A; font-weight:700;">Parameter</th>
                <th style="text-align:right; padding:10px 14px; color:#0D141A; font-weight:700;">Value</th>
                <th style="text-align:left; padding:10px 14px; color:#0D141A; font-weight:700;">Notes</th>
              </tr>
            </thead>
            <tbody>
              {[...costs, ...benefits].map((item, idx, arr) => (
                <tr style={idx < arr.length - 1 ? 'border-bottom:1px solid #f3f4f6;' : ''}>
                  <td style="padding:9px 14px; color:#56585E;">{item.label}</td>
                  <td style="padding:9px 14px; text-align:right; color:#0D141A; font-weight:600;">{fmtConfigValue(item.value, item.format)}</td>
                  <td style="padding:9px 14px; color:#9ca3af;">{item.note}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </details>

    </div>
  </div>

  <!-- CTA STRIP -->
  <section style="background:#0F2041; padding:80px 24px; text-align:center;">
    <div style="max-width:600px; margin:0 auto;">
      <h2 style="color:#fff; font-size:clamp(1.6rem, 3vw, 2.2rem); font-weight:700; letter-spacing:-0.02em; margin:0 0 16px;">
        Ready to secure your fortress?
      </h2>
      <p style="color:rgba(255,255,255,0.65); font-size:1rem; margin:0 0 32px; line-height:1.7;">
        These numbers are based on conservative assumptions. A real pilot typically delivers even faster payback. Let's talk.
      </p>
      <div style="display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
        <a href={`mailto:${meta.contactEmail}?subject=JDFortVault%20Pilot%20Request`} style="background:#1E6FF5; color:#fff; padding:14px 28px; border-radius:8px; text-decoration:none; font-weight:600; font-size:1rem;" onmouseover="this.style.background='#1558cc'" onmouseout="this.style.background='#1E6FF5'">
          Schedule a Pilot
        </a>
        <a href="/contact" style="background:rgba(255,255,255,0.1); color:#fff; padding:14px 28px; border-radius:8px; text-decoration:none; font-weight:600; font-size:1rem; border:1px solid rgba(255,255,255,0.2);" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
          Contact Us
        </a>
      </div>
    </div>
  </section>

</Layout>

<style is:global>
  .calc-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, #1E6FF5 0%, #1E6FF5 var(--pct, 4%), #e0e8f5 var(--pct, 4%), #e0e8f5 100%);
    outline: none;
    cursor: pointer;
  }
  .calc-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #0F2041;
    border: 3px solid #fff;
    box-shadow: 0 1px 6px rgba(15,32,65,0.3);
    cursor: pointer;
    transition: transform 0.15s;
  }
  .calc-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .calc-slider::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #0F2041;
    border: 3px solid #fff;
    box-shadow: 0 1px 6px rgba(15,32,65,0.3);
    cursor: pointer;
  }
  .calc-slider:focus {
    outline: 2px solid #1E6FF5;
    outline-offset: 3px;
    border-radius: 3px;
  }
  @media print {
    body > * { display: none !important; }
    #print-area { display: block !important; }
  }
</style>

<!-- HIDDEN PRINT AREA -->
<div id="print-area" style="display:none; padding:48px; max-width:800px; margin:0 auto; font-family:system-ui,sans-serif;">
  <div id="print-content"></div>
</div>

<!-- Inject config + proposal template into global scope (runs before module script) -->
<script is:inline define:vars={{ _C: C_obj, _SL: sliderLimits, _proposalTemplate: proposalTemplate, _meta: { contactEmail: meta.contactEmail, contactPhone: meta.contactPhone, founders: meta.founders, foundersTitle: meta.foundersTitle, foundersQuote: meta.foundersQuote } }}>
  window.__calcC                = _C;
  window.__calcSL               = _SL;
  window.__calcProposalTemplate = _proposalTemplate;
  window.__calcMeta             = _meta;
</script>

<script>
// ============================================================
// CONFIG (sourced from config.yaml + _proposal.md at build time)
// ============================================================
const C                 = (window as any).__calcC                as Record<string, number>;
const SL                = (window as any).__calcSL               as { lawyers: { min: number; max: number; default: number }; vaults: { min: number; max: number; default: number }; years: { min: number; max: number; default: number } };
const PROPOSAL_TEMPLATE = (window as any).__calcProposalTemplate as string;
const META              = (window as any).__calcMeta             as { contactEmail: string; contactPhone: string; founders: string; foundersTitle: string; foundersQuote: string };

// ============================================================
// TEMPLATE RENDERER
// Replaces every {{key}} in the HTML template with the
// corresponding string from the vars map.
// ============================================================
function renderTemplate(template: string, vars: Record<string, string>): string {
  return template.replace(/\{\{(\w+)\}\}/g, (_, key) => {
    return key in vars ? vars[key] : `{{${key}}}`;
  });
}

// ============================================================
// FORMATTING HELPERS
// ============================================================
function fmtGBP(n: number, decimals = 0): string {
  if (!isFinite(n)) return 'â€”';
  return 'Â£' + n.toLocaleString('en-GB', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  });
}
function fmtNum(n: number, decimals = 1): string {
  if (!isFinite(n)) return 'â€”';
  return n.toLocaleString('en-GB', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  });
}
function fmtMo(n: number): string {
  if (!isFinite(n) || n <= 0) return 'â€”';
  return `${n} month${n === 1 ? '' : 's'}`;
}

// ============================================================
// CALCULATIONS
// ============================================================
function calculate(numLawyers: number, numVaults: number, timeHorizon: number) {
  // Guard: clamp to slider limits from YAML; vault max is also capped at 2Ã— lawyers
  numLawyers  = Math.max(SL.lawyers.min, Math.min(SL.lawyers.max,               Math.round(numLawyers)));
  const vaultDynMax = Math.min(SL.vaults.max, 2 * numLawyers);
  numVaults   = Math.max(SL.vaults.min,  Math.min(vaultDynMax,                  Math.round(numVaults)));
  timeHorizon = Math.max(SL.years.min,   Math.min(SL.years.max,                 Math.round(timeHorizon)));

  // --- COSTS ---
  const hardware     = numVaults * C.HARDWARE_PER_VAULT;
  const setup        = C.SETUP_FIRST + (numVaults - 1) * C.SETUP_ADDITIONAL;
  const training     = C.TRAINING;
  const subtotal     = hardware + setup + training;
  const vat          = C.VAT * subtotal;
  const totalInitial = subtotal + vat;

  const electricityMo  = C.ELECTRICITY_PER_VAULT * numVaults;
  // Flat-rate support covers vaults 1â€“3; each vault beyond 3 adds a per-vault charge
  const additionalVaults = Math.max(0, numVaults - 3);
  const supportMo      = C.SUPPORT_FLAT_RATE + additionalVaults * C.SUPPORT_PER_ADDITIONAL;
  const totalRunningMo = electricityMo + supportMo;
  const totalRunningYr = totalRunningMo * 12;

  let npvRunning = 0;
  for (let t = 1; t <= timeHorizon; t++) {
    npvRunning += totalRunningYr / Math.pow(1 + C.DISCOUNT_RATE, t);
  }
  const totalCostNPV = totalInitial + npvRunning;

  // --- SAVINGS ---
  const timeSavedPerLawyerMo    = C.HOURS_PER_MONTH * (1 - 1 / C.PRODUCTIVITY_MULT);
  const totalTimeSavedMo        = timeSavedPerLawyerMo * numLawyers;
  const equivalentFTE           = totalTimeSavedMo / C.HOURS_PER_MONTH;

  const avoidedHiring           = equivalentFTE * C.HIRING_COST_PER_FTE;
  const salarySavingsYr         = C.AVG_SALARY_YEAR * equivalentFTE;
  const totalCostSavings        = (salarySavingsYr * timeHorizon) + avoidedHiring;

  const additionalBillableMo    = totalTimeSavedMo * C.RECOUP_RATE;
  const additionalRevenueMo     = additionalBillableMo * C.BILLING_RATE;
  const additionalRevenueYr     = additionalRevenueMo * 12;
  const additionalRevenueHorizon = additionalRevenueYr * timeHorizon;

  const totalMoneySaved         = additionalRevenueHorizon + totalCostSavings;

  // ROI payback â€” guard against division by zero
  let roiMonths: number;
  if (totalMoneySaved <= 0) {
    roiMonths = Infinity;
  } else {
    roiMonths = Math.ceil((totalCostNPV / totalMoneySaved) * 12 * timeHorizon);
  }

  return {
    numLawyers, numVaults, timeHorizon,
    hardware, setup, training, subtotal, vat, totalInitial,
    electricityMo, supportMo, totalRunningMo, totalRunningYr,
    totalCostNPV,
    timeSavedPerLawyerMo, totalTimeSavedMo, equivalentFTE,
    avoidedHiring, salarySavingsYr, totalCostSavings,
    additionalBillableMo, additionalRevenueMo, additionalRevenueYr,
    additionalRevenueHorizon, totalMoneySaved,
    roiMonths,
  };
}

// ============================================================
// ANIMATION
// ============================================================
const animState: Record<string, number | null> = {};

function animateTo(id: string, targetText: string): void {
  const el = document.getElementById(id);
  if (!el) return;

  const numMatch = targetText.replace(/[Â£,]/g, '').match(/[\d.]+/);
  if (!numMatch) { el.textContent = targetText; return; }

  const target = parseFloat(numMatch[0]);
  const prefix = targetText.startsWith('Â£') ? 'Â£' : '';
  const suffix = targetText.includes('month') ? (target === 1 ? ' month' : ' months') : '';

  const current = parseFloat((el.textContent || '0').replace(/[Â£,]/g, '').match(/[\d.]+/)?.[0] || '0');

  if (animState[id] !== null) cancelAnimationFrame(animState[id]!);

  const start = performance.now();
  const duration = 400;

  function step(now: number) {
    const elapsed = Math.min((now - start) / duration, 1);
    const eased = 1 - Math.pow(1 - elapsed, 3);
    const val = current + (target - current) * eased;

    if (prefix === 'Â£') {
      el.textContent = 'Â£' + Math.round(val).toLocaleString('en-GB') + suffix;
    } else if (suffix.includes('month')) {
      el.textContent = Math.round(val) + suffix;
    } else {
      el.textContent = val.toFixed(1) + suffix;
    }

    if (elapsed < 1) {
      animState[id] = requestAnimationFrame(step);
    } else {
      el.textContent = targetText;
      animState[id] = null;
    }
  }

  animState[id] = requestAnimationFrame(step);
}

// ============================================================
// DOM UPDATES
// ============================================================
function updateUI(r: ReturnType<typeof calculate>, firmName: string): void {
  const maxHorizonMonths = r.timeHorizon * 12;
  const roiDisplay = !isFinite(r.roiMonths)
    ? 'N/A'
    : r.roiMonths > maxHorizonMonths
      ? `>${maxHorizonMonths} months`
      : fmtMo(r.roiMonths);

  animateTo('kpi-cost',    fmtGBP(r.totalCostNPV));
  animateTo('kpi-savings', fmtGBP(r.totalMoneySaved));

  const roiEl = document.getElementById('kpi-roi');
  if (roiEl) roiEl.textContent = roiDisplay;

  setText('b-initial',     fmtGBP(r.totalInitial));
  setText('b-vault-count', String(r.numVaults));
  setText('b-hardware',    fmtGBP(r.hardware));
  setText('b-setup',       fmtGBP(r.setup + r.training));
  setText('b-support-mo',  fmtGBP(r.supportMo, 2) + '/mo');
  setText('b-elec-mo',     fmtGBP(r.electricityMo, 2) + '/mo');

  setText('b-salary-yr',   fmtGBP(r.salarySavingsYr) + '/yr');
  setText('b-revenue-yr',  fmtGBP(r.additionalRevenueYr) + '/yr');
  setText('b-fte',         fmtNum(r.equivalentFTE, 1) + ' FTE');
  setText('b-billable-mo', fmtNum(r.additionalBillableMo, 1) + ' hrs/mo');
  setText('b-time-saved',  fmtNum(r.timeSavedPerLawyerMo, 1) + ' hrs');

  updateProposal(r, firmName, roiDisplay);
}

function setText(id: string, val: string): void {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function updateProposal(r: ReturnType<typeof calculate>, firmName: string, roiDisplay: string): void {
  const firm = firmName.trim() || 'Your Firm';
  const dateStr = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

  setText('proposal-firm', firm);
  setText('proposal-date', dateStr);

  const body = document.getElementById('proposal-body');
  if (!body) return;

  const roiClause = !isFinite(r.roiMonths) || r.roiMonths > r.timeHorizon * 12
    ? `with payback expected within the evaluation period`
    : `with ROI in under <strong>${roiDisplay}</strong>`;

  // Build the vars map â€” keys match {{placeholders}} in _proposal.md
  const vars: Record<string, string> = {
    firmName:        firm,
    productivityMult: String(C.PRODUCTIVITY_MULT),
    numLawyers:      String(r.numLawyers),
    lawyerPlural:    r.numLawyers === 1 ? '' : 's',
    avgSalary:       fmtGBP(C.AVG_SALARY_YEAR),
    billingRate:     fmtGBP(C.BILLING_RATE),
    numVaults:       String(r.numVaults),
    vaultPlural:     r.numVaults === 1 ? '' : 's',
    totalInitial:    fmtGBP(r.totalInitial),
    totalRunningMo:  fmtGBP(r.totalRunningMo, 2),
    salarySavingsYr: fmtGBP(r.salarySavingsYr),
    equivalentFTE:   fmtNum(r.equivalentFTE, 1),
    ftePlural:       r.equivalentFTE >= 2 ? 's' : '',
    revenueYr:       fmtGBP(r.additionalRevenueYr),
    timeHorizon:     String(r.timeHorizon),
    yearPlural:      r.timeHorizon === 1 ? '' : 's',
    totalSaved:      fmtGBP(r.totalMoneySaved),
    roiClause,
    contactEmail:    META.contactEmail,
    contactPhone:    META.contactPhone,
    founders:        META.founders,
    foundersTitle:   META.foundersTitle,
    foundersQuote:   META.foundersQuote,
  };

  body.innerHTML = renderTemplate(PROPOSAL_TEMPLATE, vars);

  const printContent = document.getElementById('print-content');
  if (printContent) {
    printContent.innerHTML = `
      <h1 style="color:#0F2041; font-size:24px; margin:0 0 4px;">JD Fortress AI \u2014 Investment Proposal</h1>
      <p style="color:#56585E; font-size:13px; margin:0 0 32px;">Prepared for: ${firm} | ${dateStr}</p>
      ${body.innerHTML}
      <hr style="margin:32px 0; border:none; border-top:1px solid #e0e8f5;" />
      <p style="font-size:12px; color:#9ca3af;">All figures are estimates based on conservative assumptions. See jdfortress.com/calculator for full methodology.</p>
    `;
  }
}

// ============================================================
// SLIDER SYNC
// ============================================================
function syncSlider(sliderId: string, numId: string, min: number, max: number): void {
  const slider   = document.getElementById(sliderId) as HTMLInputElement | null;
  const numInput = document.getElementById(numId)    as HTMLInputElement | null;
  if (!slider || !numInput) return;

  function updateTrack() {
    const pct = ((parseFloat(slider!.value) - min) / (max - min)) * 100;
    slider!.style.setProperty('--pct', pct + '%');
  }

  slider.addEventListener('input', () => {
    let v = parseInt(slider.value, 10);
    v = Math.max(min, Math.min(max, v));
    numInput.value = String(v);
    updateTrack();
    recalculate();
  });

  numInput.addEventListener('input', () => {
    let raw = numInput.value.replace(/[^0-9]/g, '');
    if (raw === '') return;
    let v = parseInt(raw, 10);
    if (isNaN(v)) return;
    v = Math.max(min, Math.min(max, v));
    slider.value = String(v);
    numInput.value = String(v);
    updateTrack();
    recalculate();
  });

  numInput.addEventListener('blur', () => {
    let v = parseInt(numInput.value, 10);
    if (isNaN(v) || numInput.value.trim() === '') v = parseInt(slider.value, 10);
    v = Math.max(min, Math.min(max, v));
    slider.value = String(v);
    numInput.value = String(v);
    updateTrack();
    recalculate();
  });

  numInput.addEventListener('keydown', (e: KeyboardEvent) => {
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      let v = Math.min(max, parseInt(numInput.value, 10) + 1);
      numInput.value = String(v);
      slider.value = String(v);
      updateTrack();
      recalculate();
    }
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      let v = Math.max(min, parseInt(numInput.value, 10) - 1);
      numInput.value = String(v);
      slider.value = String(v);
      updateTrack();
      recalculate();
    }
  });

  updateTrack();
}

// ============================================================
// DYNAMIC VAULT MAX  (max vaults = 2 Ã— current lawyers)
// ============================================================
function updateVaultMax(): void {
  const lawyersEl   = document.getElementById('num-lawyers')    as HTMLInputElement;
  const vaultSlider = document.getElementById('slider-vaults')  as HTMLInputElement;
  const vaultNum    = document.getElementById('num-vaults')     as HTMLInputElement;
  const maxLabel    = document.getElementById('vault-max-label');
  if (!lawyersEl || !vaultSlider || !vaultNum) return;

  const lawyers = parseInt(lawyersEl.value, 10) || SL.lawyers.default;
  const dynMax  = Math.min(SL.vaults.max, 2 * lawyers);

  // Update slider + input constraints
  vaultSlider.max = String(dynMax);
  vaultNum.max    = String(dynMax);
  if (maxLabel) maxLabel.textContent = String(dynMax);

  // Clamp current vault value if it now exceeds the new max
  const cur = parseInt(vaultNum.value, 10);
  if (cur > dynMax) {
    vaultNum.value    = String(dynMax);
    vaultSlider.value = String(dynMax);
  }

  // Re-paint the slider track gradient
  const min = SL.vaults.min;
  const pct = ((parseFloat(vaultSlider.value) - min) / (dynMax - min)) * 100;
  vaultSlider.style.setProperty('--pct', pct + '%');
}

// ============================================================
// MAIN RECALCULATE
// ============================================================
let debounceTimer: ReturnType<typeof setTimeout> | null = null;

function recalculate(): void {
  if (debounceTimer) clearTimeout(debounceTimer);
  debounceTimer = setTimeout(_recalculate, 30);
}

function _recalculate(): void {
  updateVaultMax(); // enforce 2Ã— lawyers constraint before reading vault value
  const lawyers  = parseInt((document.getElementById('num-lawyers')  as HTMLInputElement).value, 10) || SL.lawyers.default;
  const vaults   = parseInt((document.getElementById('num-vaults')   as HTMLInputElement).value, 10) || SL.vaults.default;
  const years    = parseInt((document.getElementById('num-years')    as HTMLInputElement).value, 10) || SL.years.default;
  const firmName = (document.getElementById('customer-name') as HTMLInputElement).value;

  const result = calculate(lawyers, vaults, years);
  updateUI(result, firmName);
}

// ============================================================
// PDF / EMAIL
// ============================================================
function printProposal(): void {
  const printArea = document.getElementById('print-area');
  if (printArea) {
    printArea.style.display = 'block';
    window.print();
    setTimeout(() => { printArea.style.display = 'none'; }, 1000);
  }
}

function emailProposal(): void {
  const firm   = (document.getElementById('customer-name') as HTMLInputElement)?.value.trim() || 'Your Firm';
  const lawyers = (document.getElementById('num-lawyers')  as HTMLInputElement)?.value || String(SL.lawyers.default);
  const vaults  = (document.getElementById('num-vaults')   as HTMLInputElement)?.value || String(SL.vaults.default);
  const years   = (document.getElementById('num-years')    as HTMLInputElement)?.value || String(SL.years.default);

  const r = calculate(parseInt(lawyers), parseInt(vaults), parseInt(years));
  const roiDisplay = !isFinite(r.roiMonths) ? 'N/A' : `${r.roiMonths} months`;

  const subject = encodeURIComponent(`JDFortVault ROI Proposal \u2014 ${firm}`);
  const body = encodeURIComponent(
    `JD Fortress AI \u2014 Cost Reduction Proposal for ${firm}\n\n` +
    `INPUTS\n` +
    `Lawyers: ${r.numLawyers} | Vaults: ${r.numVaults} | Time horizon: ${r.timeHorizon} years\n\n` +
    `RESULTS\n` +
    `Total Cost (NPV): ${fmtGBP(r.totalCostNPV)}\n` +
    `Total Savings & Revenue: ${fmtGBP(r.totalMoneySaved)}\n` +
    `ROI Payback: ${roiDisplay}\n\n` +
    `Salary savings: ${fmtGBP(r.salarySavingsYr)}/yr | FTE avoided: ${fmtNum(r.equivalentFTE, 1)}\n` +
    `Additional revenue: ${fmtGBP(r.additionalRevenueYr)}/yr\n\n` +
    `Generated at jdfortress.com/calculator\n` +
    `Contact: ${META.contactEmail} | ${META.contactPhone}`
  );
  window.location.href = `mailto:${META.contactEmail}?subject=${subject}&body=${body}`;
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  syncSlider('slider-lawyers', 'num-lawyers', SL.lawyers.min, SL.lawyers.max);
  syncSlider('slider-vaults',  'num-vaults',  SL.vaults.min,  SL.vaults.max);
  syncSlider('slider-years',   'num-years',   SL.years.min,   SL.years.max);

  updateVaultMax(); // set initial vault max = 2 Ã— default lawyers

  document.getElementById('customer-name')?.addEventListener('input', recalculate);

  _recalculate();
});

(window as any).printProposal = printProposal;
(window as any).emailProposal = emailProposal;
</script>
